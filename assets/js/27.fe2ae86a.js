(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{604:function(t,s,a){t.exports=a.p+"assets/img/2020-03-26-18-06-13.10565d67.png"},605:function(t,s,a){t.exports=a.p+"assets/img/2020-03-26-18-46-30.a20c9350.png"},762:function(t,s,a){"use strict";a.r(s);var e=a(10),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[t._v("这篇文章只是简单的探讨记录下 "),e("code",[t._v("devServer.proxy")]),t._v(" 的相关配置和兼容性")]),t._v(" "),e("h2",{attrs:{id:"背景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[t._v("#")]),t._v(" 背景")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://cli.vuejs.org/zh/config/#devserver-proxy",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("vue-cli-service")]),e("OutboundLink")],1),t._v(" > v3.x")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/chimurai/http-proxy-middleware#proxycontext-config",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("http-proxy-middleware")]),e("OutboundLink")],1)])]),t._v(" "),e("h2",{attrs:{id:"正文"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#正文"}},[t._v("#")]),t._v(" 正文")]),t._v(" "),e("p",[e("img",{attrs:{src:a(604),alt:"官方文档"}})]),t._v(" "),e("p",[t._v("官方文档如图所示，简单的介绍了 "),e("code",[t._v("devServer.proxy")]),t._v(" 的用法。并给出了对应的 "),e("a",{attrs:{href:"https://github.com/chimurai/http-proxy-middleware#proxycontext-config",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("http-proxy-middleware")]),e("OutboundLink")],1),t._v(" 链接，告诉我们 "),e("code",[t._v("完整选项请查阅")]),t._v(".")]),t._v(" "),e("h2",{attrs:{id:"问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),e("p",[t._v("现在问题来了，这个参数真的和官方文档所说的一样兼容吗？")]),t._v(" "),e("p",[t._v("就目前来看，答案肯定是 "),e("code",[t._v("不")]),t._v("。")]),t._v(" "),e("p",[t._v("我们从源码开始分析吧。")]),t._v(" "),e("p",[e("a",{attrs:{href:"packages/@vue/cli-service/lib/util/prepareProxy.js"}},[t._v("源码 prepareProxy.js")])]),t._v(" "),e("h3",{attrs:{id:"问题一-proxy类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题一-proxy类型"}},[t._v("#")]),t._v(" 问题一 proxy类型")]),t._v(" "),e("p",[t._v("源码："),e("a",{attrs:{href:"https://github.com/vuejs/vue-cli/blob/dev/packages/%40vue/cli-service/lib/util/prepareProxy.js#L30",target:"_blank",rel:"noopener noreferrer"}},[t._v("prepareProxy.js#L30"),e("OutboundLink")],1)]),t._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("div",{staticClass:"custom-style-wrapper window-controls"},[e("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",width:"54",height:"14",viewBox:"0 0 54 14"}},[e("g",{attrs:{fill:"none","fill-rule":"evenodd",transform:"translate(1 1)"}},[e("circle",{attrs:{cx:"6",cy:"6",r:"6",fill:"#FF5F56",stroke:"#E0443E","stroke-width":".5"}}),e("circle",{attrs:{cx:"26",cy:"6",r:"6",fill:"#FFBD2E",stroke:"#DEA123","stroke-width":".5"}}),e("circle",{attrs:{cx:"46",cy:"6",r:"6",fill:"#27C93F",stroke:"#1AAB29","stroke-width":".5"}})])])]),e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("module"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("exports")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("prepareProxy")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("proxy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" appPublicFolder")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// `proxy` lets you specify alternate servers for specific requests.")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// It can either be a string or an object conforming to the Webpack dev server proxy configuration")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// https://webpack.github.io/docs/webpack-dev-server.html")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("proxy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Array"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("isArray")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("proxy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" proxy "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'object'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" proxy "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      chalk"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("red")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'When specified, \"proxy\" in package.json must be a string or an object.'")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      chalk"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("red")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'Instead, the type of "proxy" was "\'')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" proxy "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\".'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      chalk"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("red")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Either remove \"proxy\" from package.json, or make it an object.'")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    process"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br"),e("span",{staticClass:"line-number"},[t._v("20")]),e("br"),e("span",{staticClass:"line-number"},[t._v("21")]),e("br"),e("span",{staticClass:"line-number"},[t._v("22")]),e("br"),e("span",{staticClass:"line-number"},[t._v("23")]),e("br"),e("span",{staticClass:"line-number"},[t._v("24")]),e("br"),e("span",{staticClass:"line-number"},[t._v("25")]),e("br")]),e("CodeResult",{attrs:{lang:"js",code:"module.exports%20%3D%20function%20prepareProxy%20(proxy%2C%20appPublicFolder)%20%7B%0A%20%20%2F%2F%20%60proxy%60%20lets%20you%20specify%20alternate%20servers%20for%20specific%20requests.%0A%20%20%2F%2F%20It%20can%20either%20be%20a%20string%20or%20an%20object%20conforming%20to%20the%20Webpack%20dev%20server%20proxy%20configuration%0A%20%20%2F%2F%20https%3A%2F%2Fwebpack.github.io%2Fdocs%2Fwebpack-dev-server.html%0A%20%20if%20(!proxy)%20%7B%0A%20%20%20%20return%20undefined%0A%20%20%7D%0A%20%20if%20(Array.isArray(proxy)%20%7C%7C%20(typeof%20proxy%20!%3D%3D%20'object'%20%26%26%20typeof%20proxy%20!%3D%3D%20'string'))%20%7B%0A%20%20%20%20console.log(%0A%20%20%20%20%20%20chalk.red(%0A%20%20%20%20%20%20%20%20'When%20specified%2C%20%22proxy%22%20in%20package.json%20must%20be%20a%20string%20or%20an%20object.'%0A%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20console.log(%0A%20%20%20%20%20%20chalk.red('Instead%2C%20the%20type%20of%20%22proxy%22%20was%20%22'%20%2B%20typeof%20proxy%20%2B%20'%22.')%0A%20%20%20%20)%0A%20%20%20%20console.log(%0A%20%20%20%20%20%20chalk.red(%0A%20%20%20%20%20%20%20%20'Either%20remove%20%22proxy%22%20from%20package.json%2C%20or%20make%20it%20an%20object.'%0A%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20process.exit(1)%0A%20%20%7D%0A%20%20...%0A%7D"}})],1),e("p",[t._v("从上面的源码中，我们可以看出 "),e("code",[t._v("vue-cli")]),t._v(" 对 "),e("code",[t._v("devServer.proxy")]),t._v(" 的入参进行了校验，首先就排除它不能是 "),e("code",[t._v("Array")]),t._v(", 并且给出的提示也不完全正确 "),e("code",[t._v('"proxy" in package.json')]),t._v("，其实这里并不知道这个配置是在 "),e("code",[t._v("vue.config.js")]),t._v(" 中，还是 "),e("code",[t._v("package.json")]),t._v(" 中。")]),t._v(" "),e("p",[t._v("但是 "),e("code",[t._v("http-proxy-middleware")]),t._v(" 的配置是支持数组的。")]),t._v(" "),e("p",[e("strong",[t._v("解决方法：")])]),t._v(" "),e("p",[t._v("等待官方更新，或者将数组转换成对象。")]),t._v(" "),e("h3",{attrs:{id:"问题二-context参数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题二-context参数"}},[t._v("#")]),t._v(" 问题二 context参数")]),t._v(" "),e("p",[t._v("源码："),e("a",{attrs:{href:"https://github.com/vuejs/vue-cli/blob/dev/packages/%40vue/cli-service/lib/util/prepareProxy.js#L73",target:"_blank",rel:"noopener noreferrer"}},[t._v("prepareProxy.js#L73"),e("OutboundLink")],1)]),t._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("div",{staticClass:"custom-style-wrapper window-controls"},[e("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",width:"54",height:"14",viewBox:"0 0 54 14"}},[e("g",{attrs:{fill:"none","fill-rule":"evenodd",transform:"translate(1 1)"}},[e("circle",{attrs:{cx:"6",cy:"6",r:"6",fill:"#FF5F56",stroke:"#E0443E","stroke-width":".5"}}),e("circle",{attrs:{cx:"26",cy:"6",r:"6",fill:"#FFBD2E",stroke:"#DEA123","stroke-width":".5"}}),e("circle",{attrs:{cx:"46",cy:"6",r:"6",fill:"#27C93F",stroke:"#1AAB29","stroke-width":".5"}})])])]),e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("context")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("pathname"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" req")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// is a static asset")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mayProxy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pathname"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Explicit context, e.g. /api")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" pathname"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("match")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// not a static request")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("method "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GET'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Heuristics: if request `accept`s text/html, we pick /index.html.")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Modern browsers include text/html into `accept` header when navigating.")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// However API calls like `fetch()` won’t generally accept text/html.")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// If this heuristic doesn’t work well for you, use a custom `proxy` object.")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            req"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("accept "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n            req"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("accept"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("indexOf")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'text/html'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br"),e("span",{staticClass:"line-number"},[t._v("20")]),e("br"),e("span",{staticClass:"line-number"},[t._v("21")]),e("br"),e("span",{staticClass:"line-number"},[t._v("22")]),e("br"),e("span",{staticClass:"line-number"},[t._v("23")]),e("br")]),e("CodeResult",{attrs:{lang:"js",code:"context%20(pathname%2C%20req)%20%7B%0A%20%20%20%20%2F%2F%20is%20a%20static%20asset%0A%20%20%20%20if%20(!mayProxy(pathname))%20%7B%0A%20%20%20%20%20%20%20%20return%20false%0A%20%20%20%20%7D%0A%20%20%20%20if%20(context)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20Explicit%20context%2C%20e.g.%20%2Fapi%0A%20%20%20%20%20%20%20%20return%20pathname.match(context)%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20not%20a%20static%20request%0A%20%20%20%20%20%20%20%20if%20(req.method%20!%3D%3D%20'GET')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20true%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2F%2F%20Heuristics%3A%20if%20request%20%60accept%60s%20text%2Fhtml%2C%20we%20pick%20%2Findex.html.%0A%20%20%20%20%20%20%20%20%2F%2F%20Modern%20browsers%20include%20text%2Fhtml%20into%20%60accept%60%20header%20when%20navigating.%0A%20%20%20%20%20%20%20%20%2F%2F%20However%20API%20calls%20like%20%60fetch()%60%20won%E2%80%99t%20generally%20accept%20text%2Fhtml.%0A%20%20%20%20%20%20%20%20%2F%2F%20If%20this%20heuristic%20doesn%E2%80%99t%20work%20well%20for%20you%2C%20use%20a%20custom%20%60proxy%60%20object.%0A%20%20%20%20%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20req.headers.accept%20%26%26%0A%20%20%20%20%20%20%20%20%20%20%20%20req.headers.accept.indexOf('text%2Fhtml')%20%3D%3D%3D%20-1%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%7D%0A%7D%2C"}})],1),e("p",[t._v("从上面的源码中，我们可以看出 "),e("code",[t._v("vue-cli")]),t._v(" 的 "),e("code",[t._v("devServer.proxy")]),t._v(" 不支持 "),e("code",[t._v("context")]),t._v(", 因为内部源码自己实现了一个 "),e("code",[t._v("context")]),t._v(" 的封装，最终覆盖你设置的参数。")]),t._v(" "),e("p",[t._v("这都不是问题，问题在于 "),e("code",[t._v("context")]),t._v(" 内不支持 "),e("code",[t._v("glob")]),t._v(" 表达式了。而且只支持标准的 "),e("code",[t._v("正则表达式")]),t._v("。")]),t._v(" "),e("p",[t._v("官方通过 "),e("code",[t._v("pathname.match(context)")]),t._v(" 这个方法，进行了一次正则校验。导致 "),e("code",[t._v("http-proxy-middleware")]),t._v(" 下的 "),e("code",[t._v("glob")]),t._v(" 写法报错。坑呀。")]),t._v(" "),e("p",[t._v("这个问题也被别人作为 "),e("code",[t._v("PR")]),e("a",{attrs:{href:"https://github.com/vuejs/vue-cli/pull/2869",target:"_blank",rel:"noopener noreferrer"}},[t._v("#2869"),e("OutboundLink")],1),t._v(" 提交了采纳了，应该会在后面的版本进行同步修复了。")]),t._v(" "),e("p",[e("strong",[t._v("解决方法：")])]),t._v(" "),e("p",[t._v("等待官方更新，或者将所有 "),e("code",[t._v("glob")]),t._v(" 表达式转换为标准的 "),e("code",[t._v("正则表达式")]),t._v("。")]),t._v(" "),e("h3",{attrs:{id:"问题三-onerror监听"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题三-onerror监听"}},[t._v("#")]),t._v(" 问题三 onError监听")]),t._v(" "),e("p",[t._v("源码："),e("a",{attrs:{href:"https://github.com/vuejs/vue-cli/blob/dev/packages/%40vue/cli-service/lib/util/prepareProxy.js#L100",target:"_blank",rel:"noopener noreferrer"}},[t._v("prepareProxy.js#L100"),e("OutboundLink")],1)]),t._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("div",{staticClass:"custom-style-wrapper window-controls"},[e("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",width:"54",height:"14",viewBox:"0 0 54 14"}},[e("g",{attrs:{fill:"none","fill-rule":"evenodd",transform:"translate(1 1)"}},[e("circle",{attrs:{cx:"6",cy:"6",r:"6",fill:"#FF5F56",stroke:"#E0443E","stroke-width":".5"}}),e("circle",{attrs:{cx:"26",cy:"6",r:"6",fill:"#FFBD2E",stroke:"#DEA123","stroke-width":".5"}}),e("circle",{attrs:{cx:"46",cy:"6",r:"6",fill:"#27C93F",stroke:"#1AAB29","stroke-width":".5"}})])])]),e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n    onError"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("onProxyError")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("target"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")]),e("CodeResult",{attrs:{lang:"js",code:"%7B%0A%20%20%20%20...%0A%20%20%20%20onError%3A%20onProxyError(target)%0A%7D"}})],1),e("div",{staticClass:"language-js line-numbers-mode"},[e("div",{staticClass:"custom-style-wrapper window-controls"},[e("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",width:"54",height:"14",viewBox:"0 0 54 14"}},[e("g",{attrs:{fill:"none","fill-rule":"evenodd",transform:"translate(1 1)"}},[e("circle",{attrs:{cx:"6",cy:"6",r:"6",fill:"#FF5F56",stroke:"#E0443E","stroke-width":".5"}}),e("circle",{attrs:{cx:"26",cy:"6",r:"6",fill:"#FFBD2E",stroke:"#DEA123","stroke-width":".5"}}),e("circle",{attrs:{cx:"46",cy:"6",r:"6",fill:"#27C93F",stroke:"#1AAB29","stroke-width":".5"}})])])]),e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Object"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("assign")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" defaultConfig"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" config"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" entry"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")]),e("CodeResult",{attrs:{lang:"js",code:"...%0Areturn%20Object.assign(%7B%7D%2C%20defaultConfig%2C%20config%2C%20entry)"}})],1),e("p",[t._v("至于第三个 "),e("code",[t._v("onError")]),t._v(" 事件监听，官方直接内部实现了，并且最终覆盖了你的方法, "),e("a",{attrs:{href:"https://github.com/vuejs/vue-cli/blob/dev/packages/%40vue/cli-service/lib/util/prepareProxy.js#L133",target:"_blank",rel:"noopener noreferrer"}},[t._v("prepareProxy.js#L133"),e("OutboundLink")],1),t._v(" 我们可以从这里看到。")]),t._v(" "),e("p",[e("strong",[t._v("解决方法：")])]),t._v(" "),e("p",[t._v("等待官方更新。")]),t._v(" "),e("h3",{attrs:{id:"host获取"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#host获取"}},[t._v("#")]),t._v(" host获取")]),t._v(" "),e("p",[t._v("当我们使用 "),e("code",[t._v("http-proxy-middleware")]),t._v(" 时，很多情况下都是直接通过框架内部自动修改 "),e("code",[t._v("Host")]),t._v(" 头信息等去使用的。")]),t._v(" "),e("p",[t._v("但是当后端采用一些框架如 "),e("code",[t._v("koa")]),t._v(" 时，本身代理的 "),e("code",[t._v("host")]),t._v(" 是没有问题的。")]),t._v(" "),e("p",[e("img",{attrs:{src:a(605),alt:"Koa文档"}})]),t._v(" "),e("p",[t._v("看文档，当 "),e("code",[t._v("app.proxy = true")]),t._v(" 时，"),e("code",[t._v("http-proxy-middleware")]),t._v(" 本身是不会修改 "),e("code",[t._v("X-Forwarded-Host")]),t._v(" 这个参数的。所以你需要认为干预一下。")]),t._v(" "),e("p",[e("strong",[t._v("解决方法：")])]),t._v(" "),e("p",[t._v("在 "),e("code",[t._v("proxy")]),t._v(" 配置 "),e("code",[t._v("onProxyReq")]),t._v(" 并在方法中实现如下代码。")]),t._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("div",{staticClass:"custom-style-wrapper window-controls"},[e("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",width:"54",height:"14",viewBox:"0 0 54 14"}},[e("g",{attrs:{fill:"none","fill-rule":"evenodd",transform:"translate(1 1)"}},[e("circle",{attrs:{cx:"6",cy:"6",r:"6",fill:"#FF5F56",stroke:"#E0443E","stroke-width":".5"}}),e("circle",{attrs:{cx:"26",cy:"6",r:"6",fill:"#FFBD2E",stroke:"#DEA123","stroke-width":".5"}}),e("circle",{attrs:{cx:"46",cy:"6",r:"6",fill:"#27C93F",stroke:"#1AAB29","stroke-width":".5"}})])])]),e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" host "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("onProxyReq")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("proxyReq"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" req"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    proxyReq"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setHeader")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'host'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" host"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxyReq"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setHeader")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'x-forwarded-host'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" host"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")]),e("CodeResult",{attrs:{lang:"js",code:"const%20host%20%3D%20''%3B%0AonProxyReq(proxyReq%2C%20req%2C%20res)%20%7B%0A%20%20%20%20proxyReq.setHeader('host'%2C%20host)%3B%0A%20%20%20%20proxyReq.setHeader('x-forwarded-host'%2C%20host)%3B%0A%7D%2C"}})],1),e("h2",{attrs:{id:"总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),e("p",[t._v("综上，简单的总结了下最近迁移和使用 "),e("code",[t._v("vue-cli-service")]),t._v(" 的代理一些问题。希望可以给大家带来一些帮助。")])])}),[],!1,null,null,null);s.default=n.exports}}]);